#!/usr/bin/env bash
# soul-sync — Extract knowledge from agent runtimes into the portable soul repo
#
# Usage:
#   soul-sync                    # Sync from default sources
#   soul-sync --dry-run          # Show what would change without writing
#   soul-sync --commit           # Sync and auto-commit
#   soul-sync --source /path     # Sync from a specific knowledge directory

set -euo pipefail

# --- Configuration ---

SOUL_DIR="${SOUL_DIR:-$HOME/.soul}"
KNOWLEDGE_DIR="$SOUL_DIR/knowledge"
CORE_DIR="$SOUL_DIR/core"

# Agent knowledge directories to sync FROM (configure for your setup)
AGENT_SOURCES=(
  # Add your agent framework's knowledge directory here, e.g.:
  # "$HOME/.agent/knowledge/memories"
  # "$HOME/.kiro/agents/MyAgent/knowledge/memories"
)

DRY_RUN=false
AUTO_COMMIT=false
CUSTOM_SOURCE=""

# --- Parse args ---

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run) DRY_RUN=true; shift ;;
    --commit) AUTO_COMMIT=true; shift ;;
    --source) CUSTOM_SOURCE="$2"; shift 2 ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

if [[ -n "$CUSTOM_SOURCE" ]]; then
  AGENT_SOURCES=("$CUSTOM_SOURCE")
fi

# --- File mapping ---
# Maps agent knowledge files → portable soul files
# Format: "source_filename:dest_path:merge_strategy"
# Strategies: copy (overwrite), append (add new entries), merge-sections (combine by heading)

declare -A FILE_MAP=(
  ["lessons.md"]="knowledge/learning.md:merge-sections"
  ["preferences.md"]="knowledge/learning.md:merge-sections"
  ["decisions.md"]="knowledge/learning.md:merge-sections"
  ["user-profile.md"]="core/user.md:copy"
  ["bookmarks.md"]="knowledge/bookmarks.md:copy"
  ["continuity.md"]="knowledge/continuity.md:copy"
  ["sessions.md"]="knowledge/continuity.md:merge-sections"
  ["followups.md"]="knowledge/followups.md:copy"
)

# Section mapping for merge-sections strategy
# Maps source file → which section heading it goes under in the dest
declare -A SECTION_MAP=(
  ["lessons.md"]="## Lessons"
  ["preferences.md"]="## Preferences"
  ["decisions.md"]="## Decisions"
  ["sessions.md"]="## Sessions"
)

# --- Functions ---

log() { echo "[soul-sync] $*"; }
dry() { if $DRY_RUN; then echo "[dry-run] $*"; return 0; fi; return 1; }

ensure_dirs() {
  mkdir -p "$KNOWLEDGE_DIR" "$CORE_DIR"
}

sync_file_copy() {
  local src="$1" dest="$SOUL_DIR/$2"
  if [[ ! -f "$src" ]]; then return; fi

  if [[ -f "$dest" ]] && diff -q "$src" "$dest" >/dev/null 2>&1; then
    return  # identical, skip
  fi

  if dry "Would copy $src → $dest"; then return; fi
  mkdir -p "$(dirname "$dest")"
  cp "$src" "$dest"
  log "Copied $(basename "$src") → $2"
}

sync_file_merge_sections() {
  local src="$1" dest="$SOUL_DIR/$2" section="${SECTION_MAP[$(basename "$src")]:-}"
  if [[ ! -f "$src" ]]; then return; fi
  if [[ -z "$section" ]]; then
    # No section mapping, fall back to copy
    sync_file_copy "$src" "$2"
    return
  fi

  # Extract content from source (skip the first heading line)
  local content
  content=$(tail -n +2 "$src" | sed '/^$/d' | head -50)
  if [[ -z "$content" ]]; then return; fi

  # Ensure dest exists with basic structure
  if [[ ! -f "$dest" ]]; then
    if dry "Would create $dest with section $section"; then return; fi
    mkdir -p "$(dirname "$dest")"
    cat > "$dest" << 'EOF'
# Learning

## Lessons

## Preferences

## Decisions
EOF
    log "Created $2"
  fi

  # Check if content already present (simple dedup)
  if grep -qF "$(echo "$content" | head -1)" "$dest" 2>/dev/null; then
    return  # already synced
  fi

  if dry "Would merge $(basename "$src") into $2 under '$section'"; then return; fi

  # Append content under the right section using awk
  awk -v section="$section" -v content="$content" '
    $0 == section { print; print ""; print content; next }
    { print }
  ' "$dest" > "$dest.tmp" && mv "$dest.tmp" "$dest"

  log "Merged $(basename "$src") → $2 ($section)"
}

sync_source() {
  local source_dir="$1"
  if [[ ! -d "$source_dir" ]]; then
    log "Skipping $source_dir (not found)"
    return
  fi

  log "Syncing from $source_dir"

  for src_file in "$source_dir"/*.md; do
    [[ -f "$src_file" ]] || continue
    local basename=$(basename "$src_file")
    local mapping="${FILE_MAP[$basename]:-}"

    if [[ -z "$mapping" ]]; then
      log "  No mapping for $basename, skipping"
      continue
    fi

    local dest_path="${mapping%%:*}"
    local strategy="${mapping##*:}"

    case "$strategy" in
      copy) sync_file_copy "$src_file" "$dest_path" ;;
      merge-sections) sync_file_merge_sections "$src_file" "$dest_path" ;;
      *) log "  Unknown strategy '$strategy' for $basename" ;;
    esac
  done
}

do_commit() {
  if ! $AUTO_COMMIT; then return; fi
  if $DRY_RUN; then dry "Would commit changes"; return; fi

  cd "$SOUL_DIR"
  if [[ ! -d .git ]]; then
    log "Soul dir is not a git repo, skipping commit"
    return
  fi

  if git diff --quiet && git diff --cached --quiet; then
    log "No changes to commit"
    return
  fi

  local timestamp=$(date +%Y-%m-%d)
  git add -A
  git commit -m "soul: sync knowledge $timestamp" --quiet
  log "Committed changes"
}

# --- Main ---

ensure_dirs

for source in "${AGENT_SOURCES[@]}"; do
  sync_source "$source"
done

do_commit

log "Done."
