#!/usr/bin/env bash
# soul-sync — Bidirectional sync between agent runtimes and the portable soul repo
#
# Reads soul.config.yml for all domain sources and destinations.
# All sync is straight copy/mirror — no format translation.
#
# Usage:
#   soul-sync                    # Forward: agent runtime → soul repo
#   soul-sync --reverse          # Reverse: soul repo → agent runtime
#   soul-sync --dry-run          # Show what would change
#   soul-sync --commit           # Sync and auto-commit soul repo

set -euo pipefail

SOUL_DIR="${SOUL_DIR:-$HOME/.soul}"
CONFIG_FILE="$SOUL_DIR/soul.config.yml"

DRY_RUN=false
AUTO_COMMIT=false
REVERSE=false

while [[ $# -gt 0 ]]; do
  case $1 in
    --dry-run) DRY_RUN=true; shift ;;
    --commit) AUTO_COMMIT=true; shift ;;
    --reverse) REVERSE=true; shift ;;
    *) echo "Unknown option: $1"; exit 1 ;;
  esac
done

# --- Config parsing ---

parse_config() {
  if [[ ! -f "$CONFIG_FILE" ]]; then
    echo "No config found at $CONFIG_FILE" >&2; exit 1
  fi
  python3 -c "
import yaml, json, os
with open('$CONFIG_FILE') as f:
    cfg = yaml.safe_load(f)
domains = cfg.get('knowledge', {}).get('domains', {})
for name, d in domains.items():
    d['source'] = os.path.expanduser(d.get('source', ''))
    d['dest'] = d.get('dest', './knowledge/' + name)
print(json.dumps(domains))
"
}

# --- Sync ---

log() { echo "[soul-sync] $*"; }

sync_domain() {
  local name="$1" src="$2" dest="$3"

  if $REVERSE; then
    # Reverse: soul repo → agent runtime
    local tmp="$src"
    src="$SOUL_DIR/$dest"
    dest="$tmp"
  else
    # Forward: agent runtime → soul repo
    src="$src"
    dest="$SOUL_DIR/$dest"
  fi

  if [[ ! -d "$src" ]]; then
    log "Skipping '$name' — $src not found"
    return 0
  fi

  local direction="→"
  $REVERSE && direction="←"

  if $DRY_RUN; then
    local count
    count=$(find "$src" -name "*.md" | wc -l | tr -d ' ')
    log "[dry-run] $name: would sync $count files $direction"
    return 0
  fi

  mkdir -p "$dest"
  rsync -a --update --include='*.md' --include='*.json' --include='*/' --exclude='*' "$src/" "$dest/"
  local count
  count=$(find "$src" -name "*.md" | wc -l | tr -d ' ')
  log "$name: synced $count files $direction"
}

do_commit() {
  $AUTO_COMMIT || return 0
  $REVERSE && return 0  # don't commit on reverse sync
  if $DRY_RUN; then log "[dry-run] Would commit changes"; return 0; fi
  local git_root
  git_root=$(cd "$SOUL_DIR" && git rev-parse --show-toplevel 2>/dev/null) || { log "Not a git repo, skipping commit"; return 0; }
  cd "$git_root"
  if git diff --quiet 2>/dev/null && git diff --cached --quiet 2>/dev/null; then log "No changes to commit"; return 0; fi
  git add -A
  git commit -m "soul: sync knowledge $(date +%Y-%m-%d)" --quiet
  log "Committed changes"
}

# --- Main ---

mkdir -p "$SOUL_DIR"

DOMAINS_JSON=$(parse_config)
DOMAIN_LIST=$(mktemp)
echo "$DOMAINS_JSON" | python3 -c "
import json, sys
domains = json.load(sys.stdin)
for name, d in domains.items():
    print(f\"{name}\t{d['source']}\t{d['dest']}\")
" > "$DOMAIN_LIST"
echo "" >> "$DOMAIN_LIST"

while IFS=$'\t' read -r name source dest || [[ -n "$name" ]]; do
  [[ -n "$name" ]] || continue
  sync_domain "$name" "$source" "$dest" || true
done < "$DOMAIN_LIST"

rm -f "$DOMAIN_LIST"
do_commit
log "Done."
